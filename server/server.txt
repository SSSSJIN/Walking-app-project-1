const express = require('express');
const oracledb = require('oracledb');
const cors = require('cors');
const path = require('path');
require('dotenv').config();

const app = express();

// ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));
app.use(cors());

// ì •ì  íŒŒì¼ ì œê³µ (ì—…ë¡œë“œëœ ì´ë¯¸ì§€)
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// Oracle DB ì—°ê²° ì„¤ì •
const dbConfig = {
    user: process.env.DB_USER,
    password: process.env.DB_PASSWORD,
    connectString: process.env.DB_CONNECT_STRING
};

// ì—°ê²° í’€ ì´ˆê¸°í™”
async function initializeDB() {
    try {
        await oracledb.createPool({
            ...dbConfig,
            poolMin: 2,
            poolMax: 10,
            poolIncrement: 1,
            poolTimeout: 300
        });
        console.log('âœ… Oracle DB ì—°ê²° í’€ ìƒì„± ì™„ë£Œ');
    } catch (err) {
        console.error('âŒ DB ì—°ê²° ì‹¤íŒ¨:', err);
        process.exit(1);
    }
}

// ë¼ìš°í„° import
const pathRoutes = require('./routes/paths');
const postRoutes = require('./routes/posts');

// ë¼ìš°í„° ì‚¬ìš©
app.use('/api/paths', pathRoutes);
app.use('/api/posts', postRoutes);

// ì„œë²„ ì‹œìž‘
const PORT = process.env.PORT || 3000;
app.listen(PORT, async () => {
    await initializeDB();
    console.log(`ðŸš€ ì„œë²„ê°€ ${PORT}ë²ˆ í¬íŠ¸ì—ì„œ ì‹¤í–‰ì¤‘ìž…ë‹ˆë‹¤.`);
});

// ì¢…ë£Œ ì‹œ ì—°ê²° í’€ ì •ë¦¬
process.on('SIGINT', async () => {
    try {
        await oracledb.getPool().close();
        console.log('DB ì—°ê²° í’€ ì¢…ë£Œ');
        process.exit(0);
    } catch (err) {
        console.error('ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', err);
        process.exit(1);
    }
});
