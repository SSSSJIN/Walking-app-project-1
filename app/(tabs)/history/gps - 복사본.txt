import React, { useEffect, useRef, useState } from 'react';
import { View, Button, Alert, Text, ScrollView, StyleSheet, TextInput, Platform } from 'react-native';
import * as Location from 'expo-location';
import MapView, { Marker, Polyline } from 'react-native-maps';
import PathService from '../../../services/PathService'; // ì„œë¹„ìŠ¤ ê²½ë¡œ í™•ì¸

type LatLng = { latitude: number; longitude: number };

export default function GpsScreen() {
  const [recording, setRecording] = useState(false);
  const [route, setRoute] = useState<LatLng[]>([]);
  const [currentPosition, setCurrentPosition] = useState<LatLng | null>(null);
  const [pathName, setPathName] = useState(''); // ê²½ë¡œ ì´ë¦„ ìƒíƒœ ì¶”ê°€
  const mapRef = useRef<MapView>(null);
  const watchRef = useRef<Location.LocationSubscription>();

  // ìœ„ì¹˜ ê¶Œí•œ ìš”ì²­
  useEffect(() => {
    (async () => {
      const { status } = await Location.requestForegroundPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('ê¶Œí•œ ì˜¤ë¥˜', 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      } // ğŸ”´ ëˆ„ë½ëœ ë‹«ëŠ” ê´„í˜¸ ì¶”ê°€
      const location = await Location.getLastKnownPositionAsync();
      if (location) {
        setCurrentPosition({
          latitude: location.coords.latitude,
          longitude: location.coords.longitude,
        });
      }
    })();
  }, []);

  // ìœ„ì¹˜ ë³€í™” ê°ì§€ ì‹œì‘
  const startRecording = async () => {
    setRecording(true);
    watchRef.current = await Location.watchPositionAsync(
      {
        accuracy: Location.Accuracy.High,
        distanceInterval: 10,
      },
      (position) => {
        const newPoint = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
        };
        setCurrentPosition(newPoint);
        setRoute((prev) => [...prev, newPoint]);
        mapRef.current?.animateCamera({
          center: newPoint,
          zoom: 16,
        });
      }
    );
  };

  // ê¸°ë¡ ì¤‘ì§€ ë° ì´ˆê¸°í™”
  const stopRecording = () => {
    if (watchRef.current) {
      watchRef.current.remove();
    }
    setRecording(false);
  };

  // ê¸°ë¡ ì´ˆê¸°í™”
  const resetRecording = () => {
    setRoute([]);
    Alert.alert('ì´ˆê¸°í™” ì™„ë£Œ', 'ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
  };

  // DB ì €ì¥
  const saveToDatabase = async () => {
    if (route.length === 0) {
      Alert.alert('ê²½ê³ ', 'ì €ì¥í•  ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    try {
      const result = await PathService.saveGPSRecord({
        pathName: pathName || 'ë¬´ì œ ê²½ë¡œ',
        coordinates: route.map((point, index) => ({
          lat: point.latitude,
          lng: point.longitude,
          type: index === 0 ? 'START' : 
                index === route.length - 1 ? 'END' : 'WAYPOINT',
          order: index + 1
        })),
        totalDistance: calculateDistance(route),
        estimatedTime: calculateTime(route)
      });

      if (result.success) {
        Alert.alert('ì €ì¥ ì„±ê³µ', 'ê²½ë¡œê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        setRoute([]);
        setPathName('');
      }
    } catch (error) {
      Alert.alert('ì €ì¥ ì‹¤íŒ¨', error.message);
    }
  };

  // ê±°ë¦¬ ê³„ì‚° (ì˜ˆì‹œ)
  const calculateDistance = (points: LatLng[]) => {
    return points.length * 0.01; // ì‹¤ì œ ê³„ì‚° ë¡œì§ êµ¬í˜„ í•„ìš”
  };

  // ì‹œê°„ ê³„ì‚° (ì˜ˆì‹œ)
  const calculateTime = (points: LatLng[]) => {
    return points.length * 2; // ì‹¤ì œ ê³„ì‚° ë¡œì§ êµ¬í˜„ í•„ìš”
  };

  return (
    <View style={styles.container}>
      <View style={styles.controls}>
        <Button
          title={recording ? 'ê¸°ë¡ ì¤‘ì§€' : 'ê¸°ë¡ ì‹œì‘'}
          onPress={recording ? stopRecording : startRecording}
        />
        {!recording && route.length > 0 && (
          <>
            <Button title="ê¸°ë¡ ì´ˆê¸°í™”" onPress={resetRecording} color="#e74c3c" />
            <Button title="DB ì €ì¥" onPress={saveToDatabase} color="#2ecc71" />
            <TextInput
              style={styles.input}
              placeholder="ê²½ë¡œ ì´ë¦„ ì…ë ¥"
              value={pathName}
              onChangeText={setPathName}
            />
          </>
        )}
      </View>

      {currentPosition && (
        <MapView
          ref={mapRef}
          style={styles.map}
          initialRegion={{
            ...currentPosition,
            latitudeDelta: 0.0922,
            longitudeDelta: 0.0421,
          }}
        >
          {route.map((point, index) => (
            <Marker
              key={index}
              coordinate={point}
              title={index === 0 ? 'ì‹œì‘ì ' : index === route.length - 1 ? 'ë„ì°©ì ' : `ê²½ìœ ì§€ ${index}`}
            />
          ))}
          {route.length > 1 && (
            <Polyline
              coordinates={route}
              strokeColor="#3498db"
              strokeWidth={4}
            />
          )}
        </MapView>
      )}

      <ScrollView style={styles.routeList}>
        <Text style={styles.routeTitle}>ê¸°ë¡ëœ ì¢Œí‘œ ({route.length}ê°œ)</Text>
        {route.map((point, idx) => (
          <Text key={idx} style={styles.routeItem}>
            {idx + 1}. ìœ„ë„: {point.latitude.toFixed(6)}, ê²½ë„: {point.longitude.toFixed(6)}
          </Text>
        ))}
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: '#fff' },
  map: { flex: 2 },
  controls: { padding: 16, gap: 10 },
  routeList: { flex: 0.3, padding: 16 },
  routeTitle: { fontSize: 18, fontWeight: 'bold', marginBottom: 12 },
  routeItem: { fontSize: 14, marginBottom: 6 },
  input: { 
    borderWidth: 1, 
    borderColor: '#ddd', 
    padding: 8, 
    marginVertical: 5 
  }
});
